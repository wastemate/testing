function viewModel(){var a=this;a.showing=ko.observable("search"),a.shouldShowWMA=ko.observable(!1),a.shouldShowSearch=ko.observable(!1),a.shouldShowCategories=ko.observable(!1),a.shouldChooseLob=ko.observable(!1),a.shouldShowResidentialServices=ko.observable(!1),a.shouldShowResidentialLandfill=ko.observable(!1),a.shouldShowResidentialRecycle=ko.observable(!1),a.shouldShowResidentialOrganics=ko.observable(!1),a.shouldShowRollOffMaterials=ko.observable(!1),a.shouldShowRollOffServices=ko.observable(!1),a.shouldChooseStart=ko.observable(!1),a.shouldShowDeliveryAndReview=ko.observable(!1),a.shouldShowBillingInfo=ko.observable(!1),a.shouldShowPaymentInfo=ko.observable(!1),a.shouldShowProcessing=ko.observable(!1),a.shouldShowConfirmation=ko.observable(!1),a.shouldShowProcessNav=ko.observable(!1),a.shouldShowProcessNavFooter=ko.observable(!1),a.noServiceSelection=ko.observable(!1),a.rolloffTermsSubjectToChange=ko.observable(!1),a.rolloffTermsUnderstandCharge=ko.observable(!1),a.rolloffTermsUnderstandRent=ko.observable(!1),a.isRecurringOrder=ko.observable(!1),a.cartsChoosen=ko.observable(!1),a.materialChoosen=ko.observable(!1),a.startChoosen=ko.observable(!1),a.addressConfirmed=ko.observable(!1),a.paymentProcessed=ko.observable(!1),a.requiresMaterial=ko.observable(!1),a.address=ko.observable(),a.categories=ko.observableArray(),a.services=ko.observableArray(),a.landfillServices=ko.observableArray(),a.recyclingServices=ko.observableArray(),a.organicsServices=ko.observableArray(),a.rolloffServices=ko.observableArray(),a.servicesHaveLoaded=ko.observable(),a.selectedService=ko.observable(),a.material=ko.observableArray(),a.selectedMaterial=ko.observable(),a.materialServices=ko.computed(function(){if(!a.rolloffServices()||!a.selectedMaterial())return[];var b=[];return _.each(a.rolloffServices(),function(c){var d=!1;_.each(a.selectedMaterial().services,function(a){c.materialName==a.materialName&&(d=!0)}),c.enabled=d,c.enabled&&b.push(c)}),b}),a.serviceDay=ko.observable(),a.serviceType=ko.computed(function(){return a.rolloffServices().length?"One-time service":"Weekly services"}),a.serviceStartDate=ko.observable(),a.serviceEndDate=ko.observable(),a.serviceFirstName=ko.observable(),a.serviceLastName=ko.observable(),a.serviceEmail=ko.observable(),a.servicePhone=ko.observable(),a.rolloffDatesChoosen=ko.computed(function(){return a.serviceStartDate()&&a.serviceEndDate()&&a.rolloffTermsSubjectToChange()&&a.rolloffTermsUnderstandCharge()&&a.rolloffTermsUnderstandRent()}),a.serviceAddress=ko.observable(),a.serviceCity=ko.observable(),a.serviceStateShort=ko.observable(),a.serviceZip=ko.observable(),a.serviceAddressApt=ko.observable(),a.serviceAddressAptPrint=ko.computed(function(){return a.serviceAddressApt()?"Apt/Suite "+a.serviceAddressApt():""}),a.serviceAddressCityStateZip=ko.computed(function(){return a.serviceCity()+", "+a.serviceStateShort()+" "+a.serviceZip()}),a.serviceAddressFull=ko.computed(function(){return a.serviceAddress()+(a.serviceAddressApt()?" #"+a.serviceAddressApt()+" ":"")+", "+a.serviceCity()+" "+a.serviceStateShort()+" "+a.serviceZip()}),a.userLatLon=ko.observable(),a.serviceMapUrl=ko.observable(),a.recurringTotal=ko.observable(),a.onetimeTotal=ko.observable(),a.billingFirstName=ko.observable(),a.billingLastName=ko.observable(),a.billingEmail=ko.observable(),a.billingPhone=ko.observable(),a.billingAddress=ko.observable(),a.billingCity=ko.observable(),a.billingStateShort=ko.observable(),a.billingZip=ko.observable(),a.billingAddressApt=ko.observable(),a.billingAddressAptPrint=ko.computed(function(){return a.billingAddressApt()?"Apt/Suite "+a.billingAddressApt():""}),a.billingAddressCityStateZip=ko.computed(function(){return a.billingCity()+", "+a.billingStateShort()+" "+a.billingZip()}),a.billingAddressFull=ko.computed(function(){return a.billingAddress()+(a.billingAddressApt()?a.billingAddressApt()+" ":"")+", "+a.billingCity()+" "+a.billingStateShort()+" "+a.billingZip()}),a.billingCard=ko.observable(),a.billingCardExpiresMonth=ko.observable(),a.billingCardExpiresYear=ko.observable(),a.billingCardSecurity=ko.observable(),a.validBillingCard=ko.observable(),a.validBillingCardExpiration=ko.observable(),a.validBillingCardSecurity=ko.observable(),a.wantsAutopay=ko.observable(!0),a.wantsPaperless=ko.observable(!0),a.accountNumber=ko.observable(""),a._billingIsSame=ko.observable(!1),a.makeBillingSame=function(){a.billingAddress(a.serviceAddress()),a.billingAddressApt(a.serviceAddressApt()),a.billingZip(a.serviceZip()),a.billingCity(a.serviceCity()),a.billingStateShort(a.serviceStateShort()),a.billingPhone(a.servicePhone())},a.toggleBillingSame=function(){a._billingIsSame(!a._billingIsSame()),console.log("billingIsSame",a._billingIsSame()),a._billingIsSame()?a.makeBillingSame():(a.billingAddress(""),a.billingAddressApt(""),a.billingZip(""),a.billingCity(""),a.billingStateShort(""),a.billingPhone(""))},a.ccExpireYearOptions=ko.computed(function(){for(var a=[],b=new Date,c=0;10>c;c++)b.setFullYear(b.getFullYear()+c),a.push({value:b.toJSON().substring(0,4)});return a}),a.avaiableDeliveryDates=ko.computed(function(){if(_.isNumber(a.serviceDay())){var b=function(b){var c=a.serviceDay(),d=7*b,e=moment().day(0).add(d+c,"days").toDate(),f={date:e,isoString:e.toJSONLocal()};return f},c=moment().add(24,"hours"),d=6,e=[],f=function(){var a=b(e.length),g=DateHelper.getHoliday(a.date);g?a=null:c.isAfter(a.date)&&(a=null),e.push(a),e.length<d?f():console.log("built list")};return f(),e=_.compact(e)}}),a.selectedServices=ko.computed(function(){if(!a.servicesHaveLoaded())return[];var b=[],c=[a.landfillServices,a.recyclingServices,a.organicsServices,a.rolloffServices];return _.each(c,function(a){var c=_.find(a(),function(a){return a.selected===!0});c&&b.push(c)}),b}),a.humanDeliveryDay=ko.computed(function(){var b="",c=a.serviceDay();if(Number(c)===c)switch(c){case 0:b="Sunday";break;case 1:b="Monday";break;case 2:b="Tuesday";break;case 3:b="Wednesday";break;case 4:b="Thursday";break;case 5:b="Friday";break;case 6:b="Saturday";break;default:b=""}return b}),a.selectedServicePrice=ko.computed(function(){var b=0,c=ko.utils.arrayFirst(a.landfillServices(),function(a){return 1==a.selected}),d=ko.utils.arrayFirst(a.recyclingServices(),function(a){return 1==a.selected}),e=ko.utils.arrayFirst(a.organicsServices(),function(a){return 1==a.selected}),f=ko.utils.arrayFirst(a.rolloffServices(),function(a){return 1==a.selected});return c&&(b+=c.price),d&&(b+=d.price),e&&(b+=e.price),f&&(b+=f.price),b}),a.orderTotal=ko.computed(function(){var b=a.selectedServicePrice();return a.wantsAutopay()||(b=2*b),"$"+b}),a.recurringTotal=ko.computed(function(){return"$"+a.selectedServicePrice()}),a.serviceMapUrl=ko.computed(function(){if(a.userLatLon()){_.templateSettings.interpolate=/{{ ([\s \S]+?)}}/g;var b=_.template("http://api.tiles.mapbox.com/v4/{{ mapid }}/{{ pin }}-{{ label }}+{{ color }}({{ lon }},{{ lat }})/{{ lon }},{{ lat }},{{ z }}/{{ width }}x{{ height }}.{{ format }}?access_token={{ token }}");return b({pin:"pin-s",label:"marker",color:"482",mapid:"mapbox.streets",lon:a.userLatLon().lon,lat:a.userLatLon().lat,z:17,width:150,height:150,format:"jpg",token:"pk.eyJ1IjoiamVkZGF3c29uIiwiYSI6ImMxYjczZWRkNzFkNWU3YzhmMTAyNzdjMjBlYThiODk2In0.HsgA69IWdvwYJyaCT7TUUg"})}}),a.loadCategory=function(b,c){console.log("Clicked"),console.log(b),wastemate.getServices(b.line).then(function(b){if(0==b.length)return a.noServiceSelection(!0),a.show("siteInfo"),void setupMiniMap(a.userLatLon().lat,a.userLatLon().lon);if(a.services([]),a.landfillServices([]),a.recyclingServices([]),a.organicsServices([]),a.rolloffServices([]),$.each(b,function(b,c){a.services.push(c),"Landfill"==c.type.name&&(c.selected=!1,c.summary="Landfill service",a.landfillServices.push(c)),"Recycling"==c.type.name&&(c.selected=!1,c.summary="Recycling service",a.recyclingServices.push(c)),"Organics"==c.type.name&&(c.selected=!1,c.summary="Recycling service",a.organicsServices.push(c)),("RollOff"==c.type.name||c.isRecurring===!1)&&(c.selected=!1,c.summary="on-call service",a.rolloffServices.push(c))}),a.landfillServices.sort(function(a,b){return a.name==b.name?0:a.name<b.name?-1:1}),a.recyclingServices.sort(function(a,b){return a.name==b.name?0:a.name<b.name?-1:1}),a.organicsServices.sort(function(a,b){return a.name==b.name?0:a.name<b.name?-1:1}),a.rolloffServices.sort(function(a,b){return a.name==b.name?0:a.name<b.name?-1:1}),a.selectResidentialDefaults(a.landfillServices,!0),a.selectResidentialDefaults(a.recyclingServices,!1),a.selectResidentialDefaults(a.organicsServices,!1),a.servicesHaveLoaded(!0),a.rolloffServices().length){var c=[];_.each(a.rolloffServices(),function(a){c.push(a.materials)}),c=_.flattenDeep(c),c=_.uniq(c,function(a){return a.name}),_.each(c,function(b){b.services=b.services||[],_.each(a.rolloffServices(),function(a){a.materialName==b.name&&b.services.push(a)})}),a.material(c),console.log(c),a.show("materials")}else a.show("residentialLandfill")},function(a){a&&alert("Address required before choosing service category")})},a.showCategories=function(b,c){a.show("categories")},a.loadServices=function(a,b){console.log("Address submitted")},a.selectMaterial=function(b,c){if(hasMatch=ko.utils.arrayFirst(a.material(),function(a){return a==b}),hasMatch&&(a.materialChoosen(!0),ko.utils.arrayForEach(a.material(),function(c){c.selected=c==b,c.selected&&a.selectedMaterial(c),c.summary=" material"})),a.material.valueHasMutated(),_.each(a.rolloffServices(),function(a){a.selected=!1}),a.selectedService(null),a.cartsChoosen(!1),1==a.selectedMaterial().services.length){var d=a.selectedMaterial().services[0];a.selectProductService(d),console.log(d)}a.show("materials")},a.isResidential=function(b){var c=!1;return _.each([a.landfillServices(),a.recyclingServices(),a.organicsServices()],function(a){_.each(a,function(a){a.guid==b.guid&&(c=!0)})}),c},a.selectProductShow=function(b){a.isResidential(b)?a.show("residential"):a.show("rolloff")},a.selectProductService=function(b,c){if("undefined"==typeof b.enabled||b.enabled){if(b.selected)return void a.selectProductShow(b);var d=[a.landfillServices,a.recyclingServices,a.organicsServices,a.rolloffServices];_.each(d,function(a){var c=a(),d=_.find(c,function(a){return a.guid===b.guid});d&&(_.each(c,function(a){a.selected=a.guid===b.guid}),a(c))}),a.selectedService(b),a.selectProductShow(b),console.log("choose item: ",b)}},a.onClickCartChangeSize=function(b,c){console.log("event",c),console.log("data",b),_.contains(a.landfillServices(),b)?(a.show("residentialLandfill"),console.log("show residentialLandfill")):_.contains(a.recyclingServices(),b)?(a.show("residentialRecycle"),console.log("show residentialRecycle")):_.contains(a.organicsServices(),b)&&(a.show("residentialOrganics"),console.log("show residentialOrganics"))},a.selectResidentialDefaults=function(a,b){var c=a();if(c&&!_.isEmpty(c)){var d=b?_.first(c):_.last(c);d&&(d.selected=!0,a.valueHasMutated())}},a.next=function(b,c){switch(a.showing()){case"residential":a.saveOrder(c,function(b){var c=[];_.each(a.avaiableDeliveryDates(),function(a){c.push(moment(a.date).toDate())});var d=[];_.times(365,function(a){var b=moment().add(a,"days"),e=!0;_.each(c,function(a){moment(b).isSame(a,"day")&&(e=!1)}),e&&d.push(b.toDate())}),$("#first-pickup-date-text").html(moment(a.serviceStartDate()||c[0]).format("L")),$("#wma-rolloff-dropoff-text").html(moment(a.serviceStartDate()||c[0]).format("L")),$("#wma-rolloff-pickup-text").html(moment(a.serviceStartDate()||c[0]).format("L")),a.serviceStartDate(moment(a.serviceStartDate()||c[0]).toDate()),a.serviceEndDate(moment(a.serviceStartDate()||c[0]).toDate());var e=$("#first-pickup-datepicker").datetimepicker({icons:{date:"fa fa-calendar",up:"fa fa-arrow-up",down:"fa fa-arrow-down"},format:"MM/dd/YY",minDate:moment(),inline:!0,disabledDates:d,sideBySide:!1,defaultDate:a.serviceStartDate()||c[0]});e.on("dp.change",function(b){var c=b.date;a.serviceStartDate(c.toDate()),$("#first-pickup-date-text").html(c.format("L")),console.log("changed",c)}),a.cartsChoosen(!0),a.show("chooseStart")});break;case"materials":if(!a.materialChoosen())return void alert("Please choose a material.");a.show("rolloff");break;case"rolloff":if(console.log(a.selectedService()),_.each(a.services(),function(b){b.selected&&a.cartsChoosen(!0)}),!a.cartsChoosen())return void alert("Please select a bin.");var d=14,e=function(a,b){var c=[],d=[];return _.times(b,function(b){var e=moment(a).add(b,"days"),f=DateHelper.getHoliday(e),g=DateHelper.isWeekday(e),h=moment(e).toDate();!f&&g?c.push(h):d.push(h)}),{daysValid:c,daysInvalid:d}},f=e(moment().add(1,"days"),d);availableDates=f.daysValid,invalidDates=f.daysInvalid,$("#wma-rolloff-dropoff-date-text").html(moment(a.serviceStartDate()||availableDates[0]).format("L")),$("#wma-rolloff-pickup-date-text").html(moment(a.serviceStartDate()||availableDates[0]).format("L")),a.serviceStartDate(moment(a.serviceStartDate()||availableDates[0]).toDate()),a.serviceEndDate(moment(a.serviceEndDate()||availableDates[0]).toDate());var g=moment(a.serviceStartDate()||availableDates[0]),h=$("#wma-rolloff-dropoff-datepicker").datetimepicker({icons:{date:"fa fa-calendar",up:"fa fa-arrow-up",down:"fa fa-arrow-down"},format:"MM/dd/YY",minDate:g,maxDate:availableDates[availableDates.length-1],inline:!0,disabledDates:invalidDates,sideBySide:!1,defaultDate:g});h.on("dp.change",function(b){var c=b.date;a.serviceStartDate(c.toDate()),$("#wma-rolloff-dropoff-date-text").html(c.format("L")),j(),console.log("changed",c)});var i,j=function(){i&&$("#wma-rolloff-pickup-datepicker").data("DateTimePicker").destroy();var b=28,c=e(moment(a.serviceStartDate()).add(1,"days"),b),d=c.daysValid,f=c.daysInvalid,g=d[0],h=d[d.length-1],j=g;i=$("#wma-rolloff-pickup-datepicker").datetimepicker({icons:{date:"fa fa-calendar",up:"fa fa-arrow-up",down:"fa fa-arrow-down"},format:"MM/dd/YY",minDate:g,maxDate:h,inline:!0,disabledDates:f,sideBySide:!1,defaultDate:j}),i.on("dp.change",function(b){var c=b.date;a.serviceEndDate(c.toDate()),$("#wma-rolloff-pickup-date-text").html(c.format("L")),console.log("changed",c)})};j(),a.saveOrder(c,function(b){return b?void console.log("Could not save order."):void a.show("deliveryAndReview")});break;case"deliveryAndReview":if(!a.rolloffTermsUnderstandCharge()||!a.rolloffTermsSubjectToChange()||!a.rolloffTermsUnderstandRent())return void alert("You must agree with the terms to continue.");wastemate.setOnDemandDates(moment(a.serviceStartDate()).toDate(),moment(a.serviceEndDate()).toDate()).then(function(){a.startChoosen(!0),a.show("siteInfo"),setupMiniMap(a.userLatLon().lat,a.userLatLon().lon)},function(a){alert("Ooops something failed :("),console.log(a)});break;case"categries":break;case"chooseStart":var k;try{k=new Date(a.serviceStartDate()).toISOString()}catch(l){return void alert("Please select a start date.")}wastemate.setRecurringStartDate(k).then(function(){a.startChoosen(!0),a.show("siteInfo"),setupMiniMap(a.userLatLon().lat,a.userLatLon().lon)},function(a){alert("Ooops something failed :("),console.log(a)});break;case"siteInfo":var m={firstName:a.serviceFirstName()||"",lastName:a.serviceLastName()||"",email:a.serviceEmail()||"",phone:a.servicePhone()||"",address:a.serviceAddressFull()||"",street:a.serviceAddress()||"",city:a.serviceCity()||"",state:a.serviceStateShort()||"",suite:a.serviceAddressApt()||"",zip:a.serviceZip()||""};if(""==m.firstName)return void alert("Oops. Missing your first name.");if(""==m.lastName)return void alert("Oops. Missing your last name.");if(""==m.email)return void alert("Oops. Missing your email.");if(""==m.street)return void alert("Oops. Missing your street address.");if(""==m.city)return void alert("Oops. Missing your city.");if(""==m.state)return void alert("Oops. Missing your address.");if(""==m.zip)return void alert("Oops. Missing your zip.");var n=function(a){var b=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return b.test(a)};if(!n(m.email))return void alert("Oops. That email isn't valid");var o=a.userLatLon().lat,p=a.userLatLon().lon;wastemate.updateAddressLocation(o,p).then(function(){wastemate.saveServiceInformation(m).then(function(){a.addressConfirmed(!0),a.show("payment")},function(a){console.log(a),alert("Oops, something went wrong.")})},function(a){console.log(a),alert("Oops, something went wrong.")});break;case"payment":if(a.saveOrderInFlight)return;if(!a.validBillingCard())return void alert("Ooops. Please enter a valid card number.");if(!a.validBillingCardExpiration())return void alert("Ooops. Please enter a valid expiration date.");if(!a.validBillingCardSecurity())return void alert("Ooops. Please enter a valid security code");if(!a.billingFirstName()||""==a.billingFirstName())return void alert("Oops. Missing first name.");if(!a.billingLastName()||""==a.billingLastName())return void alert("Ooops. Missing last name.");if(!a.billingAddress()||""==a.billingAddress())return void alert("Ooops. Missing billing address.");if(!a.billingStateShort||""==a.billingStateShort())return void alert("Ooops, Missing billing state.");if(!a.billingCity||""==a.billingCity())return void alert("Ooops, Missing billing city.");if(!a.billingZip()||""==a.billingZip())return void alert("Ooops. Missing ZIP.");a.saveOrderInFlight=!0,a.show("processing");var q={cardNumber:a.billingCard().replace(/\s/g,""),ccExpiresMonth:Number(a.billingCardExpiresMonth()),ccExpiresYear:Number(a.billingCardExpiresYear()),securityCode:a.billingCardSecurity(),fullName:a.billingFirstName()+" "+a.billingLastName(),address:a.billingAddress(),zipCode:a.billingZip()};q.cardType=$.payment.cardType(q.cardNumber),wastemate.tokenizeCard(q).then(function(b){wastemate._private.order.cardToken=b;var c=a.selectedServicePrice();a.wantsAutopay()||(c=2*c),c=~~(100*parseFloat(c)),wastemate.preAuthorizePayment(c,q).then(function(b){wastemate._private.order.set("amount",c),wastemate._private.order.set("delayedCaptureToken",b.creditCardToken),wastemate._private.order.save(),wastemate.setBillingOptions(a.wantsAutopay(),a.wantsPaperless()),wastemate.processNewOrder().then(function(b){a.saveOrderInFlight=!1,console.log(b),a.paymentProcessed(!0),a.accountNumber(b.C_ID),a.show("confirmation")},function(b){a.saveOrderInFlight=!1,a.show("payment"),console.log(b),b&&alert("Oops. There was a problem processing your order.")})},function(b){a.saveOrderInFlight=!1,a.show("payment"),console.log(b),b&&alert("Upfront payment failed.")})},function(b){a.saveOrderInFlight=!1,a.show("payment"),console.log(b),b&&alert("Credit Card information did not validate")})}window.scrollTo(0,window.scrollY)},a.saveOrderInFlight=!1,a.saveOrder=function(b,c){if(!a.saveOrderInFlight){a.saveOrderInFlight=!0;var d=[a.landfillServices,a.recyclingServices,a.organicsServices,a.rolloffServices],e=[],f=[];if(_.each(d,function(a){var b=_.find(a(),function(a){return a.selected===!0});if(b)f.push(_.clone(b));else if(!_.isEmpty(a())){var c=a[0].type.name;e.push("a "+c.toLower()+" service")}}),e.length>0)return void c(e);var g=a.selectedMaterial();g&&(g={icon:g.icon,name:g.name}),_.each(f,function(a){delete a.material,delete a.enabled,delete a.selected}),console.log(f,g),wastemate.saveServiceSelection(f,g).then(function(){console.log("saved service selection"),a.saveOrderInFlight=!1,c()},function(b){console.log("something went wrong"),console.log(b),a.saveOrderInFlight=!1,c(b)})}},a.show=function(b){console.log(b),window.invalidateAllInputs(),a.materialServices(),a._billingIsSame()&&a.makeBillingSame();var c=function(){a.shouldShowSearch(!1),a.shouldShowCategories(!1),a.shouldShowResidentialServices(!1),a.shouldShowResidentialLandfill(!1),a.shouldShowResidentialRecycle(!1),a.shouldShowResidentialOrganics(!1),a.shouldShowRollOffMaterials(!1),a.shouldShowRollOffServices(!1),a.shouldShowDeliveryAndReview(!1),a.shouldShowBillingInfo(!1),a.shouldShowPaymentInfo(!1),a.shouldShowConfirmation(!1),a.shouldShowProcessNav(!1),a.shouldShowProcessNavFooter(!1),a.shouldChooseStart(!1),a.shouldShowProcessing(!1)};switch(b){case"loading":c();break;case"search":c(),a.shouldShowSearch(!0);break;case"categries":c();var d=$("#body");d&&(a.shouldShowWMA(!0),d.hide()),a.shouldShowCategories(!0);break;case"residential":c(),a.shouldShowResidentialServices(!0),a.shouldShowProcessNav(!0),a.shouldShowProcessNavFooter(!0);break;case"residentialLandfill":c(),a.shouldShowResidentialLandfill(!0),a.shouldShowProcessNav(!0);break;case"residentialRecycle":c(),a.shouldShowResidentialRecycle(!0),a.shouldShowProcessNav(!0);break;case"residentialOrganics":c(),a.shouldShowResidentialOrganics(!0),a.shouldShowProcessNav(!0);break;case"chooseStart":c(),a.shouldChooseStart(!0),a.shouldShowProcessNav(!0),a.shouldShowProcessNavFooter(!0);break;case"deliveryAndReview":c(),a.shouldShowDeliveryAndReview(!0),a.shouldShowProcessNav(!0);break;case"materials":c(),a.shouldShowRollOffMaterials(!0),a.shouldShowProcessNav(!0),a.shouldShowProcessNavFooter(!0);break;case"rolloff":c(),a.shouldShowRollOffServices(!0),a.shouldShowProcessNav(!0),a.shouldShowProcessNavFooter(!0);break;case"siteInfo":c(),a.shouldShowBillingInfo(!0),a.shouldShowProcessNav(!0);break;case"payment":c(),a.shouldShowPaymentInfo(!0),a.shouldShowProcessNav(!0);break;case"processing":c(),a.shouldShowProcessing(!0);break;case"confirmation":c(),a.shouldShowConfirmation(!0),a.shouldShowProcessNav(!0);break;default:c()}a.showing(b)}}function bindViewFormatters(){$("#wma-cst-crdnbr").payment("formatCardNumber"),$("#wma-cst-crdnbr").on("keyup",function(){wma_viewModel.validBillingCard(!1);var a=$(this).val().replace(/\s/g,""),b=$.payment.validateCardNumber(a);16!=a.length||b?16==a.length&&b?(wma_viewModel.validBillingCard(!0),$(this).css("border","2px solid #007700"),$("#wma-cst-expmm").focus()):$(this).css("border",""):$(this).css("border","2px solid #FFCCCC");var c=$.payment.cardType(a);$("[id^=wma-cc-]").css("opacity",.3).addClass("greyscale"),("visa"==c||"amex"==c||"discover"==c||"mastercard"==c)&&$("#wma-cc-"+c).css("opacity",1).removeClass("greyscale"),a.length||$("[id^=wma-cc-]").css("opacity",1).removeClass("greyscale")}),$("#wma-cst-cvv").payment("formatCardCVC"),$("#wma-cst-cvv").on("keyup",function(){wma_viewModel.validBillingCardSecurity(!1);var a=$(this).val(),b=$.payment.validateCardCVC(a);a.length>=3&&!b?$(this).css("border","2px solid #FFCCCC"):a.length>=3&&b?(wma_viewModel.validBillingCardSecurity(!0),$(this).css("border","2px solid #007700")):$(this).css("background-color","")}),function(){var a=function(a){wma_viewModel.validBillingCardExpiration(!1),a?(wma_viewModel.validBillingCardExpiration(!0),$("#wma-cst-expmm").css("border","2px solid #007700"),$("#wma-cst-expyy").css("border","2px solid #007700")):-1==$("#wma-cst-expmm").val()||-1==$("#wma-cst-expyy").val()?($("#wma-cst-expmm").css("border",""),$("#wma-cst-expyy").css("border","")):($("#wma-cst-expmm").css("border","2px solid #FFCCCC"),$("#wma-cst-expyy").css("border","2px solid #FFCCCC"))};$("#wma-cst-expmm").on("change",function(){var b=$(this).val(),c=$("#wma-cst-expyy").val(),d=$.payment.validateCardExpiry(b,c);a(d)}),$("#wma-cst-expyy").on("change",function(){var b=$("#wma-cst-expmm").val(),c=$(this).val(),d=$.payment.validateCardExpiry(b,c);a(d)})}(),$("#wma-cst-phn").inputmask("mask",{mask:"(999) 999-9999"}),$("#wma-cst-billingphn").inputmask("mask",{mask:"(999) 999-9999"}),$("#wma-cst-billsameaddr").on("change",function(){wma_viewModel.toggleBillingSame(),window.invalidateAllInputs()}),$(".wma-billing-input").on("keyup",function(){wma_viewModel._billingIsSame(!1),$("#wma-cst-billsameaddr").removeAttr("checked")}),$(function(){$('[data-toggle="tooltip"]').tooltip()})}(function(){"use strict";var a=this,b=this.wastemate;Date.prototype.toISOString||!function(){function a(a){return 10>a?"0"+a:a}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"."+(this.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"}}();var c={_private:{host:"https://manage.wastemate.com/api/",organizationToken:"",parseAppId:"",parseJsKey:""},_config:{getLines:function(){return c._private.host+"lob/"+c._private.organizationToken},getServices:function(a,b){return c._private.host+"services/"+c._private.organizationToken+"/"+a+"?lat="+b.lat+"&lon="+b.lon},updateLocation:function(){return c._private.host+"services/validate/"+c._private.organizationToken},getServiceDay:function(a){return c._private.host+"services/dow/"+c._private.organizationToken+"?lat="+a.lat+"&lon="+a.lon},tokenizeCard:function(a){return c._private.host+"creditCard/tokenize/"+c._private.organizationToken+"/"+a},preAuthorizeCard:function(a){return c._private.host+"creditCard/payment/"+c._private.organizationToken+"/"+a},processOrder:function(){return c._private.host+"order/"+c._private.organizationToken}},_cached:{cachFor:6e5,_lob:null,_lobWhen:0,_services:null,_servicesWhen:0,clear:function(){c._cached._lob=null,c._cached._lobWhen=0,c._cached._service=null,c._cached._serviceWhen=0},lob:{get:function(){var a=Date.now();return c._cached._lob&&a-c._cached._lobWhen<c._cached.cachFor?c._cached._lob:null},set:function(a){return c._cached._lob=a,c._cached._lobWhen=Date.now(),a}},services:{get:function(){var a=Date.now();return c._cached._services&&a-c._cached._servicesWhen<c._cached.cachFor?c._cached._services:null},set:function(a){return c._cached._services=a,c._cached._servicesWhen=Date.now(),a}}},updateAddressLocation:function(a,b){return new Promise(function(d,e){var f={oldLocation:{lat:c._private.account.get("lat"),lon:c._private.account.get("lon")},newLocation:{lat:a,lon:b}},g=new XMLHttpRequest;g.open("POST",c._config.updateLocation()),g.setRequestHeader("Content-Type","application/json;charset=UTF-8"),g.onload=function(){if(200===g.status){var f=JSON.parse(g.responseText);f.samePricing&&f.sameRouting?(c._private.account.set("lat",a),c._private.account.set("lon",b),c._private.account.save(),d(f)):e(f)}else e(new Error(g.errorMessage))},g.onerror=function(){e(new Error("Network Error"))},g.send(JSON.stringify(f))})},getServiceCategories:function(){return new Promise(function(a,b){var d=c._cached.lob.get();if(d)return void a(d);var e=new XMLHttpRequest;e.open("GET",c._config.getLines()),e.setRequestHeader("Content-Type","application/json;charset=UTF-8"),e.onload=function(){200===e.status?a(c._cached.lob.set(JSON.parse(e.responseText))):b(new Error(e.statusText))},e.onerror=function(){b(new Error("Network Error"))},e.send()})},getServices:function(a){return new Promise(function(b,d){var e=c._cached.services.get();if(e)return void b(e);if(!c._private.account)return void d(new Error("Account must be set before resolving services"));var f={lat:c._private.account.get("lat"),lon:c._private.account.get("lon")},g=new XMLHttpRequest;g.open("GET",c._config.getServices(a,f)),g.setRequestHeader("Content-Type","application/json;charset=UTF-8"),g.onload=function(){200===g.status?(c.URL.appendHash("line",btoa(a)),b(c._cached.services.set(JSON.parse(g.responseText)))):d(new Error(g.statusText))},g.onerror=function(){d(new Error("Network Error"))},g.send()})},getServiceDayOfWeek:function(){return new Promise(function(a,b){if(!c._private.account)return void b(new Error("Account must be set before resolving services"));var d={lat:c._private.account.get("lat"),lon:c._private.account.get("lon")},e=new XMLHttpRequest;e.open("GET",c._config.getServiceDay(d)),e.setRequestHeader("Content-Type","application/json;charset=UTF-8"),e.onload=function(){200===e.status?a(JSON.parse(e.responseText)):b(new Error(e.statusText))},e.onerror=function(){b(new Error("Network Error"))},e.send()})},tokenizeCard:function(a){return new Promise(function(b,d){if(!c._cached.services)return void d(new Error("Services need to be loaded before tokenization"));var e={cardNumber:a.cardNumber||"",ccExpiresMonth:a.ccExpiresMonth||0,ccExpiresYear:a.ccExpiresYear||0,securityCode:a.securityCode||"",fullName:a.fullName||"",address:a.address||"",city:a.city||"",state:a.state||"",zipCode:a.zipCode,cardType:a.cardType||""},f=new XMLHttpRequest;f.open("POST",c._config.tokenizeCard(c._cached._services[0].companyId)),f.setRequestHeader("Content-Type","application/json;charset=UTF-8"),f.onload=function(){if(200===f.status){var a=JSON.parse(f.responseText);if(a.isError)return void d(new Error(a.message));a.token.cardType=e.cardType||"",c._private.cardToken=a.token,b(a.token)}else d(new Error(JSON.parse(f.responseText)))},f.onerror=function(){d(new Error("Network Error"))},f.send(JSON.stringify(e))})},preAuthorizePayment:function(a,b){return new Promise(function(d,e){if(!c._cached.services)return void e(new Error("Services need to be loaded before tokenization"));var f;if(isNaN(a)?1:(f=parseFloat(a),(0|f)!==f))return e(new Error("Amount is required and must be an integer. Ex: 32.85 is passed as 3285"));a=parseInt(a,10);var g={cardNumber:b.cardNumber||"",ccExpiresMonth:b.ccExpiresMonth||0,ccExpiresYear:b.ccExpiresYear||0,securityCode:b.securityCode||"",fullName:b.fullName||"",address:b.address||"",city:b.city||"",state:b.state||"",zipCode:b.zipCode,amount:a},h=new XMLHttpRequest;h.open("POST",c._config.preAuthorizeCard(c._cached._services[0].companyId)),h.setRequestHeader("Content-Type","application/json;charset=UTF-8"),h.onload=function(){if(200===h.status){var a=JSON.parse(h.responseText);if(a.isError)return void e(new Error(a.message));d(a.token)}else e(new Error(JSON.parse(h.responseText)))},h.onerror=function(){e(new Error("Network Error"))},h.send(JSON.stringify(g))})},saveServiceSelection:function(a,b){var d={account:c._private.account.id,services:a,isOneTime:a.length>1?!1:!0,amount:0,delayedCaptureToken:""};return b&&(d.material=b),new Promise(function(a,b){var e=Parse.Object.extend("Order"),f=new e;f.save(d).then(function(b){c._private.order=b,c.URL.appendHash("order",b.id),a(b)},function(a){b(a)})})},saveServiceInformation:function(a){var b={firstName:a.firstName||"",lastName:a.lastName||"",email:a.email||"",phone:a.phone||"",address:a.address||"",street:a.street||"",city:a.city||"",state:a.state||"",suite:a.suite||"",zip:a.zip||""};return new Promise(function(a,d){var e=c._private.account;e.set("serviceSite",b),e.save().then(function(b){c._private.account=b,a(b)},function(a){d(a)})})},setRecurringStartDate:function(a){return new Promise(function(b,d){var e=c._private.order;e.set("recurringStarts",a),e.save().then(function(a){c._private.order=a,b(a)},function(a){d(a)})})},setOnDemandDates:function(a,b){return new Promise(function(d,e){var f=c._private.order;f.set("deliverWhen",a),f.set("removeWhen",b),f.save().then(function(a){c._private.order=a,d(a)},function(a){e(a)})})},saveBillingSelection:function(a){var b={account:c._private.account.id,name:a.name,street:a.street,city:a.city,state:a.state,zip:a.zip,phone:a.phone};return new Promise(function(a,d){var e=Parse.Object.extend("BillingInfo"),f=new e;f.save(b).then(function(b){c._private.account.billingInfo=b,a(b)},function(a){d(a)})})},setBillingOptions:function(a,b){return new Promise(function(d,e){var f=c._private.account;return f?(f.set("isAutoPay",a||!1),f.set("isPaperless",b||!1),void f.save().then(function(a){c._private.account=a,d(a)},function(a){e(a)})):e(new Error("Account must be created before setting billing options"))})},processNewOrder:function(a,b,d){return new Promise(function(e,f){var g={account:a||c._private.account||null,order:b||c._private.order||null,card:d||c._private.cardToken||null};if(!g.account)return void f(new Error("Service and billing information (account) required before processing order."));if(!g.order)return void f(new Error("Requested services (order) required before processing order."));if(!g.card)return void f(new Error("Credit card token required before processing order."));var h=new XMLHttpRequest;h.open("POST",c._config.processOrder()),h.setRequestHeader("Content-Type","application/json;charset=UTF-8"),h.onload=function(){if(201===h.status||200===h.status){var a=JSON.parse(h.responseText);
c._private.encoreAccount=a,e(a)}else f(new Error(h.statusText))},h.onerror=function(){f(new Error("Network Error"))},h.send(JSON.stringify(g))})},createTempAccount:function(a){var b=!1,d={primaryNumber:a.primaryNumber||0,street:a.street||"",lat:a.lat||0,lon:a.lon||0,city:a.city||"",state:a.state||"",zip:a.zip||"",rdi:a.rdi||"",isTempAccount:!0,isMultiSearcher:b};return new Promise(function(a,b){var e=Parse.Object.extend("Account"),f=new e;f.save(d).then(function(b){c._private.account=b,c.URL.setHash("account",b.id),a(b)},function(a){b(a)})})},initialize:function(a,b){return new Promise(function(d,e){c._private.parseAppId=a,c._private.parseJsKey=b,Parse.initialize(a,b);var f=Parse.Object.extend("Config"),g=new Parse.Query(f);g.first().then(function(a){c._private.organizationToken=a.get("wasteMateOrg");var b=a.get("wasteMateHost");c._private.host=b||c._private.host,c._cached.clear(),c.getServiceCategories().then(function(a){d(a)},function(a){e(a)})},function(a){e(a)})})}};c.URL={getHash:function(a,b){var c=window.location.hash,d=c.substring(c.indexOf("=")+1);return d?d:b},setHash:function(a,b){window.location.hash=a+"="+b},appendHash:function(a,b){var d=window.location.hash;d&&d.length>0?window.location.hash+="&"+a+"="+b:c.URL.setHash(a,b)},getQuery:function(a,b){var c=window.location.search,d=c.substring(c.indexOf("=")+1);return d?d:b}},c.noConflict=function(){return a.wastemate=b,c},"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=c),exports.wastemate=c):a.wastemate=c}).call(this),$(document).ready(function(){var a="custom-input-label",b="6px 12px",c="12px 12px 0px 12px",d="slideUp",e=50,f="#BBB",g=12,h="6px 12px",i=function(a,d){var e=$(a).parent().find("label");d?($(e).css("display",""),$(a).css("padding",c,"important")):($(e).css("display","none"),$(a).css("padding",b,"important"))};window.invalidateAllInputs=function(){$("input[placeholder][type=text]").each(function(){i(this,!!$(this).val().length)})},$("input[placeholder][type=text]").each(function(){$(this).css("height",e).css("padding",b);var c=$(this).attr("placeholder");$("<label/>",{text:c,"class":a}).css("font-weight","bold").css("color",f).css("font-size",g).css("padding",h).css("position","absolute").css("visibility","hidden").addClass(d).insertBefore($(this)),$(this).on("keyup",function(){$(this).val().length?i(this,!0):i(this,!1)})})});var DateHelper={getHolidays:function(){var a=[{holiday:"Labor Day",date:"September 7, 2015"},{holiday:"Columbus Day",date:"October 12, 2015"},{holiday:"Veterans Day",date:"November 11, 2015"},{holiday:"Thanksgiving Day",date:"November 26, 2015"},{holiday:"Friday after Thanksgiving",date:"November 27, 2015"},{holiday:"Christmas Day",date:"December 25, 2015"},{holiday:"New Year's Day",date:"January 1, 2016"},{holiday:"Martin Luther King, Jr. Day",date:"January 18, 2016"},{holiday:"Presidents Day",date:"February 15, 2016"},{holiday:"Easter",date:"March 27, 2016"},{holiday:"Memorial Day",date:"May 30, 2016"},{holiday:"Independence Day",date:"July 4, 2016"},{holiday:"Labor Day",date:"September 5, 2016"},{holiday:"Columbus Day",date:"October 10, 2016"},{holiday:"Veterans Day",date:"November 11, 2016"},{holiday:"Thanksgiving Day",date:"November 24, 2016"},{holiday:"Friday after Thanksgiving",date:"November 25, 2016"},{holiday:"Christmas Day",date:"December 26, 2016"}];return _.each(a,function(a){a.date=new Date(a.date)}),a},getHoliday:function(a){return _.find(DateHelper.getHolidays(),function(b){return moment(a).isSame(b.date,"day")})||!1},isWeekday:function(a){var b=moment(a).isoWeekday();return b>=1&&5>=b?moment(a):!1},isServiceDay:function(a){return self.serviceDay==moment(a).isoWeekday-1?moment(a):!1}};Date.prototype.toJSONLocal=function(){var a=new Date(this);return a.setMinutes(this.getMinutes()-this.getTimezoneOffset()),a.toISOString().slice(0,10)},ko.observableArray.fn.refresh=function(){var a=this();this([]),this(a)},ko.extenders.required=function(a,b){function c(c){a.hasError(c?!1:!0),a.validationMessage(c?"":b||"This field is required")}return a.hasError=ko.observable(),a.validationMessage=ko.observable(),c(a()),a.subscribe(c),a},ko.bindingHandlers.backgroundImage={update:function(a,b){ko.bindingHandlers.style.update(a,function(){return{backgroundImage:"url('"+b()+"')"}})}},ko.bindingHandlers.mapAddress={update:function(a,b){ko.bindingHandlers.html.update(a,function(){var a=ko.unwrap(b());return a?'<i class="fa fa-map-marker"></i> '+a:"&nbsp;"})}};var _debug=window._debug||!1,setupLiveAddressGoogle=function(a){var b={types:["address"],componentRestrictions:{country:"us"}},c=document.getElementById("street_address"),d=new google.maps.places.Autocomplete(c,b);google.maps.event.addListener(d,"place_changed",function(){var b=d.getPlace();g([b],function(){a.show("categries")})});var e=document.getElementById("floating_address");if(e){var f=new google.maps.places.Autocomplete(e,b);google.maps.event.addListener(f,"place_changed",function(){var b=f.getPlace();g([b],function(){$("#signUp").modal("hide"),a.show("categries")})})}var g=function(a,b){var c,d=a[0].address_components;try{if(c={primaryNumber:d[0]?d[0].long_name:null,street:d[0]&&d[1]?d[0].long_name+" "+d[1].long_name:null,city:d[2]?d[2].long_name:null,stateShort:d[4]?d[4].short_name:null,zip:d[6]?d[6].long_name:null,lat:a[0].geometry.location.lat()||null,lon:a[0].geometry.location.lng()||null,rdi:""},!(c.street&&c.primaryNumber&&c.city&&c.stateShort&&c.zip&&c.lat&&c.lon))return void alert("Oops. Bad address. Please enter your full address.")}catch(e){throw e}h(c,b)},h=function(b,c){var d=function(){a.address(""),a.serviceAddress(""),a.serviceCity(""),a.serviceStateShort(""),a.serviceZip("")};a.userLatLon({lat:b.lat,lon:b.lon}),a.address(b),a.serviceAddress(b.street),a.serviceCity(b.city),a.serviceStateShort(b.stateShort),a.serviceZip(b.zip),wastemate.createTempAccount(b).then(function(b){_debug&&console.log(b),wastemate.getServiceDayOfWeek().then(function(b){if(0===b.length)return d(),void alert("Oh drats, we don't have your address configured for online sign up. Call our office to speak to a human. 238-2381");var e=b[0];return a.serviceDay(e.dow),$("#lob_address").css("border","2px solid #007700"),c?(c(),void console.log("next")):void(_debug&&console.log(b))},function(a){_debug&&console.log(a),$("#lob_address").css("border","2px solid #FFCCCC"),d(),alert("Oh drats, we don't have your address configured for online sign up. Call our office to speak to a human. 238-2381")})})}},isMapInitialized=!1,setupMiniMap=function(a,b){if(isMapInitialized)return void console.log("map already initiatlized");if(isMapInitialized=!0,console.log("setupMiniMap"),a&&b){var c,d,e,f=L.tileLayer("https://api.tiles.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiamVkZGF3c29uIiwiYSI6ImMxYjczZWRkNzFkNWU3YzhmMTAyNzdjMjBlYThiODk2In0.HsgA69IWdvwYJyaCT7TUUg"),e=L.map("interactive_map",{zoomControl:!1,attributionControl:!1,minZoom:18}).addLayer(f);e.setView([a,b],18);var g=L.marker(e.getCenter()).addTo(e);g.setOpacity(.3);var h=L.marker(e.getCenter()).addTo(e);e.on("move",function(){h.setLatLng(e.getCenter())}),e.on("moveend",function(){c=h.getLatLng().lat,d=h.getLatLng().lng,wma_viewModel.userLatLon({lat:c,lon:d}),console.log(wma_viewModel.userLatLon())})}};